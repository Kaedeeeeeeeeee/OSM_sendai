# 仙台市离线 3D 世界（OSM+DEM）Unity 方案 C 设计稿（运行时生成+本地缓存）

日期：2026-02-05  
目标读者：Unity 客户端开发、数据/工具链开发  

## 1. 目标与约束

### 目标
- 在 Unity/PC 端实现类似 F4map 的“简约但有细节”的 3D 城市观感：建筑 + 道路 + 水体 + 绿地/树林 + 起伏地形。
- 覆盖**整个仙台市**，连续大世界（非分场景）。
- **小包体**：安装包只携带“轻数据”（OSM 矢量 + DEM 高程瓦片 + 少量规则），运行时按需生成网格并**落盘缓存**。
- 地形近景使用 **10m DEM**；远景自动降级到更粗精度（30m/90m 等）以控体积/控性能。

### 非目标（MVP 不做）
- 运行时“建筑从地表挤出”的过渡动画。
- 复杂屋顶（`roof:shape` 等）与精细路口拓扑（先允许道路轻微重叠/穿插）。
- 全市一次性加载到内存。

### 约束
- 不依赖 Google Maps 付费 API。
- 可离线运行（数据随包发布），运行时缓存写入 `Application.persistentDataPath`。
- OSM（ODbL）与 DEM 数据源遵循署名/出典要求（在 Credits/关于页显示）。

## 2. 总体架构（轻数据随包 + 运行时生成 + 本地缓存）

**离线（Python 工具链）**
1) 获取并裁剪 OSM 数据（建筑/道路/水体/土地利用）。  
2) 获取 DEM，并生成多级 LOD 高程瓦片（10m/30m/90m）。  
3) 将 OSM 要素按瓦片切片并写入轻量二进制格式（可压缩）。  
4) 产出 `tileset.json`（元数据与索引）与 `tiles/`（每瓦片数据包）。

**运行时（Unity / C#）**
1) 相机移动 → `TileManager` 根据视距请求瓦片。  
2) 若瓦片已存在“生成缓存”，直接加载缓存生成 GameObject。  
3) 否则读取轻数据 → 后台生成网格/实例数据 → 主线程创建 Mesh/Renderer → 写入缓存。  
4) 超出范围瓦片卸载（保留缓存文件，不保留内存对象）。

## 3. 坐标系统与“连续大世界”精度方案

### 推荐投影与本地坐标
- 输入数据：WGS84（经纬度）。
- 运行时与网格：使用**米制平面坐标**（推荐 UTM；仙台区域通常可用 **UTM Zone 54N / EPSG:32654**）。
- 世界原点：选定一个锚点（例如仙台站经纬度），将其投影后的 (E,N) 作为 (0,0)。

### Floating Origin
为避免全市范围内 Unity 单精度浮点抖动：
- 相机/玩家距离原点超过阈值（例如 2km 或 5km）时，触发一次“世界平移”：
  - 记录一个 `worldOffset`（米制），将所有已加载瓦片与动态对象整体平移回原点附近。
  - 所有逻辑坐标使用“高精度世界坐标（double 或 long 毫米）”+ `worldOffset` 转换到 Unity `Vector3`。

## 4. 分块（Tile）与 LOD 策略

### 瓦片大小与索引
- 基础瓦片尺寸：**512m × 512m**（MVP 建议；后续可调 256m 提升细节与并行度）。
- 瓦片坐标：在本地平面坐标中用整数格子索引：
  - `tx = floor(x / tileSize)`
  - `ty = floor(z / tileSize)`
  - `tileId = (lod, tx, ty)`

### 视距与多级 LOD（建议参数，后续可配置）
- Terrain：
  - LOD0：10m DEM（近景，例：0–2km）
  - LOD1：30m DEM（中景，例：2–8km）
  - LOD2：90m DEM（远景，例：8km+）
- Features（建筑/道路/水体/植被）：
  - 近景保留完整生成结果。
  - 中景做合批与简化（建筑可合并、道路抽稀）。
  - 远景可退化为“建筑包围盒/无细节”或仅地形+雾（按性能目标取舍）。

## 5. 轻数据格式（随安装包发布）

### `tileset.json`（元数据）
建议包含：
- `projection`: `EPSG:32654`（或自定义投影描述）
- `tileSizeMeters`: 512
- `demLods`: [{lod:0,resolution:10},{lod:1,resolution:30},{lod:2,resolution:90}]
- `dataVersion`: 用于缓存失效（当数据源/切片变化时递增）
- `bounds`: 市域包围盒（投影后米制范围）

### 每瓦片 `tile_<lod>_<tx>_<ty>.bin.zst`（示例命名）
一个瓦片文件建议拆分为段：
- Buildings：多边形环（outer + holes）、高度信息、类型枚举
- Roads：中心线点列、道路等级枚举、桥/隧道标记（MVP 可忽略）
- Water：水面/河流多边形或线（MVP：水面多边形优先）
- Landcover：绿地/林地多边形（用于植被散布）
- 可选：POI 点（后续玩法用）

备注：MVP 可先用 gzip 压缩 JSON，确认流程后再替换为 protobuf/flatbuffers + zstd。

## 6. 运行时生成算法（无动画，后台生成）

### 6.1 DEM 高程采样
- 将 DEM tile 解码为规则网格（高度数组）。
- 提供 `HeightProvider.Sample(x,z)`：
  - 找到对应 DEM LOD 瓦片
  - 双线性插值采样高度
  - 返回 `y`（米）

### 6.2 建筑（平顶挤出）
输入：建筑多边形（outer + holes）与高度 `h`。  
输出：屋顶面 + 侧墙网格（可选：地基裙边）。

建议流程：
1) 将多边形顶点投影到本地平面坐标并“贴地”（对每个顶点采样地形高度 `y0`）。
2) 屋顶面：对外环/洞进行三角化（推荐 Earcut 类算法），顶点 y = `y0 + h`（或用平均地面高度做平顶）。
3) 侧墙：沿外环每条边生成一条 quad（两个三角形），底边 y = `y0`，顶边 y = `y0 + h`。
4) 法线：屋顶向上；侧墙按面法线（简约风格可用硬边法线/平面着色）。

### 6.3 道路（ribbon 生成，MVP 简化）
输入：中心线 polyline + 道路等级。  
输出：带宽的带状网格（允许路口轻微重叠）。

建议：
- 按道路等级映射宽度（m）：例如 `primary/secondary/residential/footway` 各一档。
- 对每段线求左右法向偏移，生成左右边界点并拼三角形。
- 转角用 miter 或 bevel（MVP 可先 bevel 以避免尖刺）。
- 贴地：沿道路点采样地形高度，并加一个小的 `roadOffset`（如 0.05m）避免 Z-fighting。

### 6.4 水体（平面填充）
- 水面多边形：直接三角化生成平面网格，y = 贴地高度 + `waterOffset`（如 0.02m）。
- 河流线：MVP 可先忽略或按“道路 ribbon”方式生成较窄带状水面。

### 6.5 绿地/树林（规则散布 + GPU Instancing）
输入：绿地/林地多边形。  
输出：树实例（近景 3D 树，远景 billboard/简化）+ 可选草地贴花/地表着色。

建议：
- 采用“网格抖动采样”或 Poisson disk（MVP 可先网格抖动），种子基于 `(tileId, polygonId)` 保证确定性。
- 树用 GPU Instancing（同一 mesh/material），按距离切换 LOD。
- 近景可加简单碰撞；远景不加碰撞。

## 7. 运行时模块拆分（Unity）

### 核心组件
- `TileManager`：决定哪些瓦片应加载（视距/LOD），维护瓦片状态机。
- `TileDataStore`：从 `StreamingAssets` 读取轻数据（解压/解析）。
- `HeightProvider`：提供地形采样与 DEM LOD 切换。
- `TileGenerator`：后台生成建筑/道路/水体/植被的 MeshData/InstanceData。
- `TileCache`：瓦片生成缓存（读写 `persistentDataPath`，带版本号）。
- `FloatingOrigin`：控制世界偏移，保证精度。

### 瓦片状态机（建议）
`Idle → Requested → DataLoaded → Generating → Ready → Active → Unloading → Idle`

## 8. 缓存策略（决定“首次生成成本”）

### 缓存 Key
- `tileId`（lod/tx/ty）
- `dataVersion`（轻数据版本）
- `generatorVersion`（生成规则版本：高度规则、道路宽度表、植被密度等）

### 缓存内容建议
- Mesh：顶点/法线/UV/索引（可自定义二进制，或 Unity `Mesh` 序列化替代方案）
- 植被实例：transform/scale/variantId 列表
- 可选：简化版 LOD mesh

## 9. 错误处理与降级策略
- 轻数据缺失/瓦片读失败：跳过该瓦片，仅显示地形远景 LOD（或空）。
- 多边形异常（自交/点过少）：记录日志并跳过该要素。
- 生成耗时过长：分帧/分批生成；必要时降低植被密度与中远景细节。

## 10. 验收与测试（建议）
- 固定 2 个基准视点：仙台站周边、青叶山/川内。
- 指标：
  - 相机快速移动时无明显卡死（允许后台加载渐进出现）。
  - 生成结果确定性（同 seed 同 tileId 输出一致）。
  - Floating Origin 触发后无跳闪/错位。
  - 内存稳定（瓦片卸载后回收可观）。

## 11. 里程碑（建议）
- M0（2–3 天）：单一区域小范围（几平方公里）跑通：瓦片读取→地形→建筑→缓存。
- M1（1–2 周）：加入道路、水体、绿地/树林；完成 LOD 与卸载。
- M2（2–4 周）：扩展到全市数据；优化生成与体积；完善出典/署名 UI。

## 12. 待确认事项（进入实现前最后一次对齐）
- Unity 渲染管线：URP 还是 HDRP（影响 SSAO/雾/阴影配置与性能）。
- 目标机型与帧率（决定远景 LOD 与植被密度）。
- “首次探索新区可接受的生成延迟”：例如每瓦片 < 200ms（后台分批）或允许更长但渐进显示。

